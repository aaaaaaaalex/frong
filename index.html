<head>
  <meta name="description" content="PET THE FROG! FRONGAS HAVIG A APPARTY">
  <meta name="viewport" content="width=device-width, user-scalable=no">
  <title>FRONG PARTY</title>
  <style>
    html * {
      font-family: "Comic Sans MS", "Comic Sans", Arial, Roboto, auto;
      animation: none;
      cursor: url('hande.png'), auto;
    }
    body {
      background-image:  url('grass.jpg');
      background-repeat: no-repeat;
      background-size: cover;
      overflow: hidden;
    }
    h1, label, li {
      font-weight: 800;
      color: white;
    }
    label ~ input { margin-left: 5px;}

    #score {
      text-align: center;
    }
    #scores-container {
      text-align: center;
      position: absolute; bottom: 10px; width: 100vw;
    }
    #start {
      color: white;
      font-size: 3rem;
      position: absolute;
    }
    #frong {
      display: block;
      position: absolute;
      top: 40%;
      left: 50%;
      margin-left: calc(-152px/2);
      width: 152px;
      height: 111px;
      background-size: contain;
      background-repeat: no-repeat;
      background-image: url(frong.jpg);
      background-color: white;
      box-shadow: none;
    }
    #leaderboard{
      text-align: center;
      list-style: decimal;
    }

    .hidden{display:none !important;}
    .unselectable {
      -webkit-touch-callout: none;
      -webkit-user-select: none;
      -khtml-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      user-select: none;
    }


    @keyframes wiggle {
      0% { transform: rotate(0deg); }
      20% { transform: rotate(5deg); }
      80% { transform: rotate(-5deg); }
      100% { transform: rotate(0deg); }
    }

    .wiggle {
      animation-name: wiggle;
      animation-duration: .1s;
      animation-delay: 0;
      animation-iteration-count: infinite;
    }

    .wiggle-once {
      animation-name: wiggle;
      animation-duration: .1s;
      animation-delay: 0;
      animation-iteration-count: 1;
    }

    .anim-speed-10 { animation-duration: .1s !important; }
    .anim-speed-9 { animation-duration: .15s !important; }
    .anim-speed-8 { animation-duration: .2s !important; }
    .anim-speed-7 { animation-duration: .25s !important; }
    .anim-speed-6 { animation-duration: .3s !important; }
    .anim-speed-5 { animation-duration: .35s !important; }
    .anim-speed-4 { animation-duration: .4s !important; }
    .anim-speed-3 { animation-duration: .45s !important; }
    .anim-speed-2 { animation-duration: .5s !important; }
    .anim-speed-1 { animation-duration: .55s !important; }
  </style>

  <script type='text/javascript'>
    /*         __          .__                    __  .__.__  .__  __                               .__        __          
      _______/  |_ ___.__.|  |   ____     __ ___/  |_|__|  | |__|/  |_ ___.__.    ______ ___________|__|______/  |_  ______
     /  ___/\   __<   |  ||  | _/ __ \   |  |  \   __\  |  | |  \   __<   |  |   /  ___// ___\_  __ \  \____ \   __\/  ___/
     \___ \  |  |  \___  ||  |_\  ___/   |  |  /|  | |  |  |_|  ||  |  \___  |   \___ \\  \___|  | \/  |  |_> >  |  \___ \ 
    /____  > |__|  / ____||____/\___  >  |____/ |__| |__|____/__||__|  / ____|  /____  >\___  >__|  |__|   __/|__| /____  >
         \/        \/               \/                                 \/            \/     \/         |__|             \/ 
    */
    function WiggleOnce(elem) {
      elem.classList.add('wiggle-once');
      setTimeout(function(){
        elem.classList.remove('wiggle-once');
      }, 100);
    }

    // frong is READY ... undoot hims invisibility cloak
    function ToggleVisibility(selector) {
      var selected = document.querySelectorAll(selector);
      if (selected) {
        selected.forEach( function(e){
          if (e.classList.contains('hidden'))
            e.classList.remove('hidden');
          else e.classList.add('hidden');
        });
      }
    }

    function Hide(selector) {
      selected = document.querySelectorAll(selector);
      if (selected) {
        selected.forEach( function(el) {
          el.classList.add('hidden');
        });
      }
    }

    function Show(selector) {
      selected = document.querySelectorAll(selector);
      if (selected) {
        selected.forEach( function(el) {
          el.classList.remove('hidden');
        });
      }
    }
  </script>


  <script type='text/javascript'>
    /*        __  .__.__  .__  __                               .__        __          
      __ ___/  |_|__|  | |__|/  |_ ___.__.    ______ ___________|__|______/  |_  ______
     |  |  \   __\  |  | |  \   __<   |  |   /  ___// ___\_  __ \  \____ \   __\/  ___/
     |  |  /|  | |  |  |_|  ||  |  \___  |   \___ \\  \___|  | \/  |  |_> >  |  \___ \ 
     |____/ |__| |__|____/__||__|  / ____|  /____  >\___  >__|  |__|   __/|__| /____  >
                                   \/            \/     \/         |__|             \/  */
    GameStorage = {  
      fallbackToCookieStorage: false,

      init: function() {
        try {
          localStorage.setItem('test', 1);
        } catch(err) {
          console.error('frong memory kinda bade doe :///// COOKIE TIEM');
          this.fallbackToCookieStorage = true;
        }
      },

      set: function(key, val) {
        if (!this.fallbackToCookieStorage) return localStorage.setItem(key, val);
        else return this._cookieSet(key, val);
      },

      get: function(key) {
        if (!this.fallbackToCookieStorage) return localStorage.getItem(key);
        else return this._cookieGet(key);
      },

      _cookieSet: function(key, val) {
        document.cookie = key+'='+val+';expires=Fri, 15 May 9999 23:59:59 GMT';
      },
      _cookieGet: function(key){
        var captureCookieValue = new RegExp('(?:(?:^|.*;\\s*)'+key+'\\s*\\=\\s*([^;]*).*$)|^.*$');
        return document.cookie.replace(captureCookieValue, "$1");
      },
    };

    IsDev = window.location.href.indexOf('.localhost') > -1;

    // SLOW THE HEMK DOWN FRONGO
    const Throttle = (func, limit) => {
      let lastFunc
      let lastRan
      return function() {
        const context = this
        const args = arguments
        if (!lastRan) {
          func.apply(context, args)
          lastRan = Date.now()
        } else {
          clearTimeout(lastFunc)
          lastFunc = setTimeout(function() {
            if ((Date.now() - lastRan) >= limit) {
              func.apply(context, args)
              lastRan = Date.now()
            }
          }, limit - (Date.now() - lastRan))
        }
      }
    }
  </script>

  <script type='text/javascript'>
    /*_                    _           _                         _              _____ _____ 
     | |                  | |         | |                       | |       /\   |  __ \_   _|
     | |     ___  __ _  __| | ___ _ __| |__   ___   __ _ _ __ __| |      /  \  | |__) || |  
     | |    / _ \/ _` |/ _` |/ _ \ '__| '_ \ / _ \ / _` | '__/ _` |     / /\ \ |  ___/ | |  
     | |___|  __/ (_| | (_| |  __/ |  | |_) | (_) | (_| | | | (_| |    / ____ \| |    _| |_ 
     |______\___|\__,_|\__,_|\___|_|  |_.__/ \___/ \__,_|_|  \__,_|   /_/    \_\_|   |_____|*/

    Leaderboard = {
      endpoint: 'http://wizardhat.'+window.location.hostname+'/leaderboard',

      // who are i? fr doe...
      uuid: -1,

      // (hi, Im frong!) < (hi, frong, I'm leaderboard!)
      hello: function(urName, initComplete) {
        // name doesnt actually matter after init, its just an alias for the uuid the API will gen for you
        this._leaderboardReq( 'POST', {'name': urName},
          function(xhr){
            var response = JSON.parse(xhr.responseText);
            this.uuid = response.uuid;
            initComplete(true);
          },
          function(xhr){
            OnlineEnabled = false;
            console.error("Leaderboard ain't too social today :(");
            initComplete(false);
          }
        );
      },

      // (leaderboard, I just scored!) < (oke duely noted, fromgas)
      score: function(points) {
        this._leaderboardReq( "PATCH", {'points': points, 'uuid': this.uuid},
          null, // if the request was successful there's nothing left to do!
          function(xhr){
            console.error('Themse other frong petters must have dems airpods in :(');
          }
        );
      },

      // (leaderboard, how u doin?) < (ok, smoothbrain)
      refresh: function( tellMeAboutTheLeaderboard ) {
        var leaderboard = null;
        this._leaderboardReq( "GET", {},
          function(xhr) {
            // abstract-out the xhr request and provide a clean leaderboard datastructure to the handler
            leaderboard = JSON.parse(xhr.responseText);
            tellMeAboutTheLeaderboard( leaderboard );
          },
	  function(xhr) {
            console.error("Frong petters always say YEE HAW, but now I'm asking HAW YEE? :(");
            tellMeAboutTheLeaderboard( null ); // not sure about this yet
          }
        );
      },


      _leaderboardReq: function(method, body, onsuccess, onerror) {
        const xhr = new XMLHttpRequest();
        xhr.open(method, this.endpoint, true);
        xhr.onreadystatechange = function(){
          if (xhr.readyState === XMLHttpRequest.DONE) {
            var status = xhr.status;
            if ((status >= 200 && status <= 400) && typeof onsuccess === 'function') onsuccess(xhr);
            else if (onerror) onerror(xhr);
          }
        }
        xhr.send(JSON.stringify(body));
        return 
      },

      _getContext: function(){ return this }
    }

  </script>
</head>


<body>
  <audio id='hit1' autostart="false"><source src='hit1.wav'></audio>
  <audio id='hit2' autostart="false"><source src='hit2.wav'></audio>
  <audio id='hit3' autostart="false"><source src='hit3.wav'></audio>
  <audio id='appear' autostart="false"><source src='appear.mp3'></audio>

  <h1 id='score' class='toggleVisibilityOnLoad hidden unselectable'>PET THE FRONG <br> YOUR SCORE: <span id='score-num'>0</span></h1>
  <a  id='frong' class='toggleVisibilityOnLoad hidden anim-speed-10'></a>
  
  <div id=scores-container class='toggleVisibilityOnLoad hidden'>
    <h1 id='highscore'>UR BESTEST: <span id='highscore-num'>0</span></h1>
    <hr>
    <ul id='leaderboard' class='hidden'>
      <li>Kermit: 0</li>
      <li>Kermit: 0</li>
      <li>Kermit: 0</li>
      <li>Kermit: 0</li>
      <li>Kermit: 0</li>
      <li>Kermit: 0</li>
      <li>Kermit: 0</li>
    </ul>
    <h1 id='leaderboard-offline'>Where's everyone gone :c</h1>
  </div>

  <!---           _____                                 __                 __   
  \_ |__   _____/ ____\___________   ____      _______/  |______ ________/  |_ 
   | __ \_/ __ \   __\/  _ \_  __ \_/ __ \    /  ___/\   __\__  \\_  __ \   __\
   | \_\ \  ___/|  | (  <_> )  | \/\  ___/    \___ \  |  |  / __ \|  | \/|  |  
   |___  /\___  >__|  \____/|__|    \___  >  /____  > |__| (____  /__|   |__|  
       \/     \/                        \/        \/            \/              -->
  
  <label for='urName' class='toggleVisibilityOnLoad'>gibe ur name pls...</label>
  <input type='text' id='urName' class='toggleVisibilityOnLoad' placeholder='kremit'>
  <h1 id='start' class='toggleVisibilityOnLoad wiggle'>START</h1> 
</body>


<footer>
  <script type='text/javascript'>
  function main() {
    GameStorage.init();
    var urNameElem = document.getElementById('urName');
    urNameElem.focus();
    var urName = urNameElem.value;
    var startbtn = document.getElementById('start');
    startbtn.addEventListener('click', function(e){
        Leaderboard.hello(urName, function(onlineEnabled){start(onlineEnabled)});
    });
  }

  function start(online) {
    // DOM elements (frongas of the web, ONE MIGHT SAY. ACTUALLY I DO SAY!)
    var frong  = document.getElementById('frong');
    var songe  = document.getElementById('songe');
    var appear = document.getElementById('appear');
    var hits   = document.querySelectorAll('audio[id^="hit"]'); // get all elems with id's beginning with "hit"

    // leaderboard
    var leaderboardUL = document.getElementById('leaderboard');
    var leaderboardObj = { 'name':"cremit", 'score':0, 'isMe':false };
    
    // keep 'er synced
    if (!online) {
      setInterval(function(){
        Leaderboard.refresh(function(leaderboard){
          if (leaderboard) {
            Show('#leaderboard');
            Hide('#leaderboard-offline');
            var i = 0;
            var listItems = leaderboard.querySelectorAll('#leaderboard li');
            for(i=0; i<leaderboard.listItems.length; i++){
              listItems[i].innerHTML = (leaderboard[i])['name']+": "+(leaderboard[i])['score'];
              if ((leaderboard[i])['isMe']){
                listItems[i].classList.add('me');
              } else listItems[i].clasList.remove('me');
            }
          }
          else {
            // swap leaderboard to offline version, *dont* go offline though
            Hide('#leaderboard-offline');
            Show('#leaderboard'); 
          }
        });
      }, 1000);
    }

    // petting points
    var scoreContainerElem = document.getElementById('score');
    var scoreElem = document.getElementById('score-num');
    var highscoreContainerElem = document.getElementById('highscore');
    var highscoreElem = document.getElementById('highscore-num');
    var score = 0;
    var highscore = GameStorage.get('highscore') || 0;
    highscoreElem.innerHTML = highscore;

    const LeaderboardScoreThrottled = Throttle(Leaderboard.score, 1000).bind( Leaderboard._getContext() );
    function increaseScore() {
      var points = (Math.floor( Math.random() * 80 ) + 20);
      score += points;
      WiggleOnce(scoreContainerElem);
      if (score > highscore) {
        highscore = score;
        WiggleOnce(highscoreContainerElem);
      }

      scoreElem.innerHTML = score;
      highscoreElem.innerHTML = highscore;
      GameStorage.set('highscore', highscore);
      if (online) LeaderboardScoreThrottled(points);
    }

    /* if i pet a fronge in the woods and no one is 
       around to see it, did I really pete fromge? */
    frong.addEventListener( 'click', function(e) {
      var randNum = Math.floor(Math.random() * 3);
      hits[randNum].play();
      WiggleOnce(frong);
      increaseScore();
    });

    ToggleVisibility('.toggleVisibilityOnLoad');
    appear.play();
  }

  main();
  </script>
</footer>
